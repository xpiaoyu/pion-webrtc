
<html>
<header>
  <script src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js"></script>
</header>

<body>
  <div id="signalingContainer" style="display: none">
    Browser base64 Session Description
    <br />
    <textarea id="localSessionDescription" readonly="true"></textarea>
    <br /> Golang base64 Session Description
    <br />
    <textarea id="remoteSessionDescription"></textarea>
    <br />
    <button onclick="window.startSession()"> Start Session </button>
    <br />
  </div>

  <br /> Video

  <br />
  <video id="video1" width="160" height="120" autoplay muted></video>
  <br />

  <button class="createSessionButton" onclick="start(true)"> Publish a Broadcast </button>
  <button class="createSessionButton" onclick="start(false)"> Join a Broadcast </button>
  <br />

  <br /> Logs

  <br />
  <div id="logs"></div>
  <script>
    /* eslint-env browser */
    var log = msg => {
      document.getElementById('logs').innerHTML += msg + '<br>'
    }

    let pc

    function getDisplayMedia() {
      if (navigator.getDisplayMedia) {
        // return navigator.getDisplayMedia({ video: true, audio: true });
        return navigator.getDisplayMedia({ video: true, audio: true });
      } else if (navigator.mediaDevices.getDisplayMedia) {
        return navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
      } else {
        return navigator.mediaDevices.getUserMedia({ video: { mediaSource: 'screen' }, audio: true });
      }
    }

    function getUserCamera() {
      var constraints = {
        video: { facingMode: 'environment' },
        audio: true,
      };
      return navigator.mediaDevices.getUserMedia(constraints);
    }

    function start(sender) {
      pc = new RTCPeerConnection({
        iceServers: [{
          urls: "turn:52.68.64.213:3478",
          username: "test",
          credential: "test"
        }], 
        // sdpSemantics: 'unified-plan'
      })
      pc.oniceconnectionstatechange = onStateChange
      pc.onicecandidate = onIceCandidate

      if (sender) {
        getUserCamera()
          .then(stream => {
            document.getElementById('video1').srcObject = stream
            stream.getTracks().forEach(function (track) {
              peerConnection.addTrack(track, stream)
            })
            // pc.addStream(document.getElementById('video1').srcObject = stream)
            pc.createOffer()
              .then(d => pc.setLocalDescription(d))
              .catch(log)
            console.log('[+] created offer sender side')
          }).catch(log)
      } else {
        pc.addTransceiver('video', {
          // 'direction': 'recvonly'
        })
        pc.addTransceiver('audio', {
          // 'direction': 'recvonly'
        })
        pc.createOffer()
          .then(function (d) {
            console.log('[+] setLocalDescription')
            pc.setLocalDescription(d)
            // document.getElementById('localSessionDescription').value = btoa(JSON.stringify(pc.localDescription))
            // $.post('https://aes-cdn.piaoyu.org/sdp', document.getElementById('localSessionDescription').value, function (data, status) {
            //   console.log('data:', data, 'status', status)
            //   document.getElementById('remoteSessionDescription').value = data
            //   startSession()
            // })
          })
          .catch(function (e) {
            console.log('[-] e:', e)
          })

        pc.ontrack = function (event) {
          console.log('[+] Got remote stream')
          let el = document.getElementById('video1')
          el.srcObject = event.streams[0]
          el.autoplay = true
          el.controls = true
        }
      }

      let btns = document.getElementsByClassName('createSessionButton')
      for (let i = 0; i < btns.length; i++) {
        btns[i].style = 'display: none'
      }

      document.getElementById('signalingContainer').style = 'display: block'
    }

    function onIceCandidate(event) {
      console.log('[+] onIceCandidate')
      if (event.candidate === null) {
        document.getElementById('localSessionDescription').value = btoa(JSON.stringify(pc.localDescription))
        // http://localhost:8080/sdp
        // https://aes-cdn.piaoyu.org/sdp
        $.post('http://192.168.50.78:8080/sdp', document.getElementById('localSessionDescription').value, function (data, status) {
          console.log('data:', data, 'status', status)
          document.getElementById('remoteSessionDescription').value = data
          startSession()
        })
      }
    }

    function startSession() {
      let sd = document.getElementById('remoteSessionDescription').value
      if (sd === '') {
        return alert('Session Description must not be empty')
      }

      try {
        pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(atob(sd))))
      } catch (e) {
        alert(e)
      }
    }

    function onStateChange(e) {
      log(e)
    }

    window.createSession = isPublisher => {
      let pc = new RTCPeerConnection({
        iceServers: [{
          urls: "turn:52.68.64.213:3478",
          username: "test",
          credential: "test"
        }]
      })
      pc.oniceconnectionstatechange = e => log(pc.iceConnectionState)
      pc.onicecandidate = event => {
        if (event.candidate === null) {
          document.getElementById('localSessionDescription').value = btoa(JSON.stringify(pc.localDescription))
          $.post('http://localhost:8080/sdp', document.getElementById('localSessionDescription').value, function (data, status) {
            console.log('data:', data, 'status', status)
            document.getElementById('remoteSessionDescription').value = data
            startSession()
          })
        }
      }
      console.log('hello')

      if (isPublisher) {
        navigator.mediaDevices.getUserMedia({
          video: true,
          audio: true
        })
          .then(stream => {
            pc.addStream(document.getElementById('video1').srcObject = stream)
            pc.createOffer()
              .then(d => pc.setLocalDescription(d))
              .catch(log)
          }).catch(log)
      } else {
        pc.addTransceiver('video', {
          'direction': 'recvonly'
        })
        pc.addTransceiver('audio', {
          'direction': 'recvonly'
        })
        pc.createOffer()
          .then(d => pc.setLocalDescription(d))
          .catch(log)

        pc.ontrack = function (event) {
          console.log('[+] Got remote stream')
          var el = document.getElementById('video1')
          el.srcObject = event.streams[0]
          el.autoplay = true
          el.controls = true
        }
      }

      window.startSession = () => {
        let sd = document.getElementById('remoteSessionDescription').value
        if (sd === '') {
          return alert('Session Description must not be empty')
        }

        try {
          pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(atob(sd))))
        } catch (e) {
          alert(e)
        }
      }

      let btns = document.getElementsByClassName('createSessionButton')
      for (let i = 0; i < btns.length; i++) {
        btns[i].style = 'display: none'
      }

      document.getElementById('signalingContainer').style = 'display: block'
    }
  </script>
</body>

</html>